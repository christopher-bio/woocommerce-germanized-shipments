!function(l,p,u){l(function(){var e=l(".wc-gzd-shipments-shipping-rules-rows"),s=l(".wc-gzd-shipments-shipping-rules"),i=u.template("wc-gzd-shipments-shipping-rules-row"),n=u.template("wc-gzd-shipments-shipping-rules-condition-row"),t=u.template("wc-gzd-shipments-shipping-rules-packaging-info"),a={},r=Backbone.Model.extend({updateRules:function(e,i){0===Object.keys(e).length&&(e={});var n={...this.get("rules")};n[String(i)]=e,console.log(n),this.set("rules",n)},updateConditions:function(e,i,n){0===Object.keys(e).length&&(e={});var t="rule_"===String(n).substring(0,5)?n:"rule_"+String(n),n={...this.getRule(i,n)},s={...this.get("rules")};n.conditions=e,s[String(i)][t]=n,console.log(s),this.set("rules",s)},getRulesByPackaging:function(e){var i={...this.get("rules")};return i.hasOwnProperty(String(e))?i[String(e)]:{}},getRule:function(e,i){e=this.getRulesByPackaging(e),i="rule_"===String(i).substring(0,5)?i:"rule_"+String(i);return e.hasOwnProperty(i)?e[i]:{}},getConditionsByRuleId:function(e,i){e=this.getRule(e,i);return e.hasOwnProperty("conditions")?e.conditions:{}}}),o=Backbone.View.extend({rowTemplate:i,conditionViews:{},packaging:"",initialize:function(){this.packaging=String(l(this.el).data("packaging")),this.conditionViews={},l(this.el).on("change",{view:this},this.updateModelOnChange)},block:function(){l(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){l(this.el).unblock()},getRules:function(){return this.model.getRulesByPackaging(this.packaging)},render:function(){var e=this.getRules(),n=this;this.$el.empty(),this.unblock(),_.size(e)&&l.each(e,function(e,i){n.renderRow(i)})},renderRow:function(e){var i=this,n=(i.$el.append(i.rowTemplate(e)),i.$el.find('tr[data-id="'+e.rule_id+'"]')),n=new c({model:i.model,el:n.find(".wc-gzd-shipments-shipping-rules-condition-rows")[0]});n.ruleId=e.rule_id,n.packaging=i.packaging,n.parentView=i,n.render(),i.initRow(e)},initRow:function(i){var e=this.$el.find('tr[data-id="'+i.rule_id+'"]'),n=e.parents("tbody");e.find("select").each(function(){var e=l(this).data("attribute");l(this).find('option[value="'+i[e]+'"]').prop("selected",!0)}),e.find("input.decimal").on("change",{view:this},this.onChangeDecimal),e.find("input.wc_input_price").on("change",{view:this},this.onChangePrice),e.find("input.decimal, input.wc_input_price").trigger("change"),e.find(".shipping-rule-remove").on("click",{view:this},this.onDeleteRow),e.find(".shipping-rule-add").on("click",{view:this},this.onAddRow),n.find("tr.wc-gzd-shipments-shipping-rules-packaging-info").length<=0&&(n.prepend(t),(e=n.find("tr.wc-gzd-shipments-shipping-rules-packaging-info")).find(".packaging-title").html(n.data("title")),n.data("help-tip")?e.find(".woocommerce-help-tip").attr("data-tip",n.data("help-tip")):e.find(".woocommerce-help-tip").remove(),n.data("edit-url"))&&e.find(".packaging-title").attr("href",n.data("edit-url")),l(document.body).trigger("wc-enhanced-select-init"),l(document.body).trigger("init_tooltips")},onChangeDecimal:function(e){l(this).closest("tr");var i=l(this);i.val(i.val().replace(".",p.decimal_separator))},onChangePrice:function(e){l(this).closest("tr");var i=l(this);i.val(i.val().replace(".",p.price_decimal_separator))},onDeleteRow:function(e){var e=e.data.view,i=e.model,n=e.getRules(),t="rule_"+l(this).closest("tr").data("id");return n[t]&&(delete n[t],i.updateRules(n,e.packaging)),e.render(),0<e.$el.find("tr.shipping-rule:last").length&&e.$el.find("tr.shipping-rule:last").addClass("current"),!1},onAddRow:function(e){var e=e.data.view,i=e.model,n=e.getRules(),t=n["rule_"+l(this).closest("tr").data("id")],s=_.extend({},t,{rule_id:"new-"+_.size(n)+"-"+Date.now(),newRow:!0,conditions:{},costs:""}),r=0;return l.each(t.conditions,function(e,i){var n="new-c-"+Date.now()+r;s.conditions["condition_"+n]=_.extend({},i,{condition_id:n,rule_id:s.rule_id,newRow:!0}),r++}),console.log(s),n["rule_"+s.rule_id]=s,i.updateRules(n,e.packaging),e.renderRow(s),e.$el.find('tr[data-id="'+s.rule_id+'"]').trigger("focus"),!1},updateModelOnChange:function(e){var i=e.data.view,n=i.model,e=l(e.target),t="rule_"+e.closest("tr").data("id"),s=e.data("attribute"),r=e.val(),o=i.getRules();return!(0<e.parents(".wc-gzd-shipments-shipping-rules-condition-rows").length||!e.is(":visible"))&&(e.is(":checkbox")?r=e.is(":checked")?r:"":r&&e.hasClass("decimal")?r=parseFloat(r.replace(p.decimal_separator,".")):r&&e.hasClass("wc_input_price")&&(r=parseFloat(r.replace(p.price_decimal_separator,"."))),console.log(s),void(o[t]&&String(o[t][s])===String(r)||(o[t][s]=r,String(o[t].packaging)!==String(i.packaging)?(e=o[t].packaging,(r=(s=a[e]).getRules())[t]={...o[t]},delete o[t],n.updateRules(o,i.packaging),s.model.updateRules(r,e),i.render(),s.render()):n.updateRules(o,i.packaging))))}}),d=new r({rules:p.rules}),c=o.extend({rowTemplate:n,ruleId:0,packaging:"",parentView:!1,initialize:function(){l(this.el).on("change",{view:this},this.updateModelOnChange)},getRules:function(){return this.model.getConditionsByRuleId(this.packaging,this.ruleId)},render:function(){var e=this.getRules(),n=this;this.$el.empty(),_.size(e)&&l.each(e,function(e,i){n.renderRow(i)})},renderRow:function(e){this.$el.append(this.rowTemplate(e)),this.initRow(e)},initRow:function(i){var e=this.$el.find('tr[data-condition="'+i.condition_id+'"]');e.parents("tbody");e.find("select").each(function(){var e=l(this).data("attribute");l(this).find('option[value="'+i[e]+'"]').prop("selected",!0)}),0===e.index()&&e.find(".condition-remove").hide(),e.find(".shipping-rules-type-container").hide(),e.find(".conditions-column:not(.conditions-when,.conditions-actions)").hide(),e.find(".shipping-rules-type").on("change",{view:this},this.onChangeRuleType),e.find(".shipping-rules-type").trigger("change"),e.find("input.decimal").on("change",{view:this},this.onChangeDecimal),e.find("input.wc_input_price").on("change",{view:this},this.onChangePrice),e.find("input.decimal, input.wc_input_price").trigger("change"),e.find(".condition-remove").on("click",{view:this},this.onDeleteRow),e.find(".condition-add").on("click",{view:this},this.onAddRow),l(document.body).trigger("wc-enhanced-select-init"),l(document.body).trigger("init_tooltips")},onChangeRuleType:function(e){var i=l(this).closest("tr"),n=l(this).val(),e=e.data.view;i.find(".shipping-rules-type-container").hide(),i.find(".conditions-column:not(.conditions-when,.conditions-actions)").hide(),i.find(".shipping-rules-type-container-"+n).show(),0<i.find(".shipping-rules-type-container-"+n+".shipping-rule-type-operator :input").length?i.find(".shipping-rules-type-container-"+n+".shipping-rule-type-operator :input").trigger("change"):e.updateModel(i.data("condition"),"operator",""),i.find(".shipping-rules-type-container-"+n+".shipping-rule-type-operator :input").trigger("change"),i.find(".shipping-rules-type-container-"+n).parents(".conditions-column").show()},updateModel:function(e,i,n){var t=this.model,e="condition_"+e,s=this.getRules();s[e]&&String(s[e][i])===String(n)||(s[e][i]=n,t.updateConditions(s,this.packaging,this.ruleId))},updateModelOnChange:function(e){var i=e.data.view,e=l(e.target),n=e.closest("tr").data("condition"),t=e.data("attribute"),s=e.val();if(!e.is(":visible"))return!1;e.is(":checkbox")?s=e.is(":checked")?s:"":s&&e.hasClass("decimal")?s=parseFloat(s.replace(p.decimal_separator,".")):s&&e.hasClass("wc_input_price")&&(s=parseFloat(s.replace(p.price_decimal_separator,"."))),i.updateModel(n,t,s)},onDeleteRow:function(e){var e=e.data.view,i=e.model,n=e.getRules(),t=l(this).closest("tr"),s="condition_"+t.data("condition");return n[s]&&0!==t.index()&&(delete n[s],i.updateConditions(n,e.packaging,e.ruleId)),e.render(),!1},onAddRow:function(e){var e=e.data.view,i=e.model,n=e.getRules(),t=n["condition_"+l(this).closest("tr").data("condition")],t=_.extend({},t,{condition_id:"new-c-"+_.size(n)+"-"+Date.now(),newRow:!0,costs:""});return-1!==l.inArray(t.type,["weight","total"])&&(t[t.type+"_from"]=t[t.type+"_to"],t[t.type+"_to"]=""),n["condition_"+t.condition_id]=t,i.updateConditions(n,e.packaging,e.ruleId),e.renderRow(t),!1}});e.each(function(){var e=new o({model:d,el:l(this)});e.render(),a[l(this).data("packaging")]=e,l(this).sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,helper:function(e,i){return i.children().each(function(){l(this).width(l(this).width())}),i.css("left","0"),i},start:function(e,i){i.item.css("background-color","#f6f6f6")},stop:function(e,i){i.item.removeAttr("style"),i.item.trigger("updateMoveButtons"),i.item.trigger("focus")}})}),l(document).on("change",".wc-gzd-shipments-shipping-rules-cb-all",function(){var e=l(this).parents("table");l(this).is(":checked")?e.find("input.cb").prop("checked",!0):e.find("input.cb").prop("checked",!1)}),l(document).on("click",".wc-gzd-shipments-shipping-rule-add",function(){var e=l(".new-shipping-packaging").val(),i=a[e],n=i.model.getRulesByPackaging(e),t=_.extend({},p.default_shipping_rule,{rule_id:"new-"+_.size(n)+"-"+Date.now(),packaging:e,newRow:!0}),s="new-c-"+Date.now(),r=t.conditions[0];return t.conditions={},t.conditions["condition_"+s]=_.extend({},r,{condition_id:s,rule_id:t.rule_id,newRow:!0}),n["rule_"+t.rule_id]=t,i.model.updateRules(n,e),a[e].renderRow(t),a[e].$el.find('tr[data-id="'+t.rule_id+'"]').trigger("focus"),!1}),l(document).on("click",".wc-gzd-shipments-shipping-rule-remove",function(){var n=d.get("rules"),e=l(this),i=e.parents("table"),t=[];return i.find("input.cb:checked").each(function(){var e="rule_"+l(this).val(),i=l(this).parents("tr").find(".shipping-packaging").val();t.includes(i)||t.push(i),delete n[i][e]}),d.set("rules",n),t.forEach(function(e,i){a[e].render()}),e.addClass("disabled"),i.find(".wc-gzd-shipments-shipping-rules-cb-all").prop("checked",!1),!1}),l(document).on("keydown",function(e){var i,n=s.find("tr.current"),t=l(".wc-gzd-shipments-shipping-rules.has-focus");if(0!==n.length||0!==t.length)return!(i=e.metaKey||e.ctrlKey)||"d"!==e.key&&"-"!==e.key?n&&i&&"+"===e.key?(n.find(".shipping-rule-add").trigger("click"),e.preventDefault(),e.stopPropagation(),!1):t&&i&&"a"===e.key?(t.find(".wc-gzd-shipments-shipping-rules-cb-all").prop("checked",!t.find(".wc-gzd-shipments-shipping-rules-cb-all").is(":checked")),t.find(".wc-gzd-shipments-shipping-rules-cb-all").trigger("change"),e.preventDefault(),e.stopPropagation(),!1):void 0:(0<($selected=s.find("input.cb:checked")).length?s.find(".wc-gzd-shipments-shipping-rule-remove").trigger("click"):n&&n.find(".shipping-rule-remove").trigger("click"),e.preventDefault(),e.stopPropagation(),!1)}),l(document).on("change",".wc-gzd-shipments-shipping-rules-rows input.cb, .wc-gzd-shipments-shipping-rules-cb-all",function(){0<($selected=l(this).parents("table").find("input.cb:checked")).length?s.find(".wc-gzd-shipments-shipping-rule-remove").removeClass("disabled"):s.find(".wc-gzd-shipments-shipping-rule-remove").addClass("disabled")}),l(document).on("mouseup",function(e){var i=l("table.wc-gzd-shipments-shipping-rules");i.is(e.target)||0!==i.has(e.target).length?i.addClass("has-focus"):(i.removeClass("has-focus"),i.find("tr").removeClass("current"))}),l(document).on("click",".wc-gzd-shipments-shipping-rules tbody, .wc-gzd-shipments-shipping-rules input",function(){l(this).trigger("focus")}),l(document).on("focus click",".wc-gzd-shipments-shipping-rules input, .wc-gzd-shipments-shipping-rules tr",function(e){l(this).parents("table").find("tr").removeClass("current"),l(this).closest("tr.shipping-rule").addClass("current")})})}(jQuery,wc_gzd_admin_shipping_rules_params,wp,ajaxurl);
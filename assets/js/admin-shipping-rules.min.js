!function(d,c,u){d(function(){var t=d(".wc-gzd-shipments-shipping-rules-rows"),e=d(".wc-gzd-shipments-shipping-rules-save"),n=u.template("wc-gzd-shipments-shipping-rules-row"),i=u.template("wc-gzd-shipments-shipping-rules-row-blank"),s=Backbone.Model.extend({changes:{},logChanges:function(e){var t=this.changes||{};_.each(e,function(e,n){t[n]=_.extend(t[n]||{rule_id:n},e)}),this.changes=t,this.trigger("change:rules")},discardChanges:function(e){delete(this.changes||{})[e],0===_.size(this.changes)&&a.clearUnloadConfirmation()}}),a=new(Backbone.View.extend({rowTemplate:n,initialize:function(){this.listenTo(this.model,"change:rules",this.setUnloadConfirmation),t.on("change",{view:this},this.updateModelOnChange),d(window).on("beforeunload",{view:this},this.unloadConfirmation),e.on("click",{view:this},this.onSubmit),d(document.body).on("click",".wc-gzd-shipments-shipping-rule-add",{view:this},this.onAddNewRow)},block:function(){d(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){d(this.el).unblock()},render:function(){var e=_.indexBy(this.model.get("rules"),"rule_id"),t=this;this.$el.empty(),this.unblock(),_.size(e)?(e=_.sortBy(e,function(e){return e.packaging}),d.each(e,function(e,n){t.renderRow(n)})):t.$el.append(i)},renderRow:function(e){var n=this;n.$el.append(n.rowTemplate(e)),n.initRow(e)},initRow:function(n){var e=this.$el.find('tr[data-id="'+n.rule_id+'"]');e.find("select").each(function(){var e=d(this).data("attribute");d(this).find('option[value="'+n[e]+'"]').prop("selected",!0)}),e.find(".shipping-rules-type-container").hide(),e.find(".conditions-column:not(.conditions-when)").hide(),e.find(".shipping-rules-type").on("change",{view:this},this.onChangeRuleType),e.find(".shipping-rules-delete").on("click",{view:this},this.onDeleteRow),e.find(".shipping-packaging").on("change",{view:this},this.onChangePackaging),e.find(".shipping-rules-type").trigger("change")},onChangePackaging:function(e){e.data.view.model;var n=d(this).closest("tr"),e=d(this).val();$lastTr=t.find('.shipping-packaging:has(option[value="'+e+'"]:selected)').not(this).last().parents("tr "),0<$lastTr.length?(n.insertAfter($lastTr),n.find(".shipping-packaging").focus()):n.insertAfter(t.find("tr:last")),n.addClass("packaging-"+e)},onChangeRuleType:function(e){e.data.view.model;var n=d(this).closest("tr"),e=d(this).val();n.find(".shipping-rules-type-container").hide(),n.find(".conditions-column:not(.conditions-when)").hide(),n.find(".shipping-rules-type-container-"+e).show(),n.find(".shipping-rules-type-container-"+e).parents(".conditions-column").show()},onAddNewRow:function(e){e.preventDefault();var n=e.data.view,t=n.model,i=_.indexBy(t.get("rules"),"rule_id"),e={},i=_.size(i),i=_.extend({},c.default_shipping_rule,{rule_id:"new-"+i+"-"+Date.now(),newRow:!0});e[i.rule_id]=i,t.logChanges(e),n.renderRow(i),d(".wc-gzd-shipments-shipping-rules-blank-state").remove()},onDeleteRow:function(e){var n=e.data.view,t=n.model,i=_.indexBy(t.get("rules"),"rule_id"),s={},a=d(this).closest("tr").data("id");e.preventDefault(),i[a]&&(delete i[a],s[a]=_.extend(s[a]||{},{deleted:"deleted"}),t.set("rules",i),t.logChanges(s)),n.render()},setUnloadConfirmation:function(){this.needsUnloadConfirm=!0,e.prop("disabled",!1)},clearUnloadConfirmation:function(){this.needsUnloadConfirm=!1,e.attr("disabled","disabled")},unloadConfirmation:function(e){if(e.data.view.needsUnloadConfirm)return e.returnValue=c.strings.unload_confirmation_msg,window.event.returnValue=c.strings.unload_confirmation_msg,c.strings.unload_confirmation_msg},updateModelOnChange:function(e){var n=e.data.view.model,t=d(e.target),i=t.closest("tr").data("id"),s=t.data("attribute"),a=t.val(),o=_.indexBy(n.get("rules"),"rule_id"),e={};t.is(":checkbox")&&(a=t.is(":checked")?a:""),o[i]&&o[i][s]===a||(e[i]={},e[i][s]=a),n.logChanges(e)}}))({model:new s({rules:c.rules}),el:t});a.render(),t.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,helper:function(e,n){return n.children().each(function(){d(this).width(d(this).width())}),n.css("left","0"),n},start:function(e,n){n.item.css("background-color","#f6f6f6")},stop:function(e,n){n.item.removeAttr("style"),n.item.trigger("updateMoveButtons")}});var o=!1,l=!1,r=!1;d(document.body).on("keyup keydown",function(e){l=e.shiftKey,o=e.ctrlKey||e.metaKey}),t.on("focus click",":input:visible",function(e){var n=d(this).closest("table, tbody"),t=d(this).closest("tr");("focus"===e.type&&r!==t.index()||"click"===e.type&&d(this).is(":focus"))&&(r=t.index(),l||o?l?(d("tr",n).removeClass("current"),t.addClass("selected_now").addClass("current"),0<d("tr.last_selected",n).length&&(t.index()>d("tr.last_selected",n).index()?d("tr",n).slice(d("tr.last_selected",n).index(),t.index()):d("tr",n).slice(t.index(),d("tr.last_selected",n).index()+1)).addClass("current"),d("tr",n).removeClass("last_selected"),t.addClass("last_selected")):(d("tr",n).removeClass("last_selected"),o&&d(this).closest("tr").is(".current")?t.removeClass("current"):t.addClass("current").addClass("last_selected")):(d("tr",n).removeClass("current").removeClass("last_selected"),t.addClass("current").addClass("last_selected")),d("tr",n).removeClass("selected_now"))}).on("blur",":input:visible",function(){r=!1})})}(jQuery,wc_gzd_admin_shipping_rules_params,wp,ajaxurl);
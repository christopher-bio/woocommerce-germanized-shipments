!function(a,d,r){a(function(){var e=a(".wc-gzd-shipments-shipping-rules-rows"),n=a(".wc-gzd-shipments-shipping-rules-save"),i=r.template("wc-gzd-shipments-shipping-rules-row"),t=r.template("wc-gzd-shipments-shipping-rules-row-blank"),o=Backbone.Model.extend({changes:{},logChanges:function(e){var i=this.changes||{};_.each(e,function(e,n){i[n]=_.extend(i[n]||{rule_id:n},e)}),this.changes=i,this.trigger("change:rules")},discardChanges:function(e){delete(this.changes||{})[e],0===_.size(this.changes)&&s.clearUnloadConfirmation()}}),s=new(Backbone.View.extend({rowTemplate:i,initialize:function(){this.listenTo(this.model,"change:rules",this.setUnloadConfirmation),e.on("change",{view:this},this.updateModelOnChange),a(window).on("beforeunload",{view:this},this.unloadConfirmation),n.on("click",{view:this},this.onSubmit),a(document.body).on("click",".wc-gzd-shipments-shipping-rule-add",{view:this},this.onAddNewRow)},block:function(){a(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){a(this.el).unblock()},render:function(){var e=_.indexBy(this.model.get("rules"),"rule_id"),i=this;this.$el.empty(),this.unblock(),_.size(e)?a.each(e,function(e,n){i.renderRow(n)}):i.$el.append(t)},renderRow:function(e){var n=this;n.$el.append(n.rowTemplate(e)),n.initRow(e)},initRow:function(n){var e=this.$el.find('tr[data-id="'+n.rule_id+'"]');e.find("select").each(function(){var e=a(this).data("attribute");a(this).find('option[value="'+n[e]+'"]').prop("selected",!0)}),e.find(".shipping-rules-type-container").hide(),e.find(".conditions-column:not(.conditions-when)").hide(),e.find(".shipping-rules-type").on("change",{view:this},this.onChangeRuleType),e.find(".shipping-rules-delete").on("click",{view:this},this.onDeleteRow),e.find(".shipping-rules-type").trigger("change")},onChangeRuleType:function(e){e.data.view.model;var n=a(this).closest("tr"),e=a(this).val();n.find(".shipping-rules-type-container").hide(),n.find(".conditions-column:not(.conditions-when)").hide(),n.find(".shipping-rules-type-container-"+e).show(),n.find(".shipping-rules-type-container-"+e).parents(".conditions-column").show()},onAddNewRow:function(e){e.preventDefault();var n=e.data.view,i=n.model,t=_.indexBy(i.get("rules"),"rule_id"),e={},t=_.size(t),t=_.extend({},d.default_shipping_rule,{rule_id:"new-"+t+"-"+Date.now(),newRow:!0});e[t.rule_id]=t,i.logChanges(e),n.renderRow(t),a(".wc-gzd-shipments-shipping-rules-blank-state").remove()},onDeleteRow:function(e){var n=e.data.view,i=n.model,t=_.indexBy(i.get("rules"),"rule_id"),o={},s=a(this).closest("tr").data("id");e.preventDefault(),t[s]&&(delete t[s],o[s]=_.extend(o[s]||{},{deleted:"deleted"}),i.set("rules",t),i.logChanges(o)),n.render()},setUnloadConfirmation:function(){this.needsUnloadConfirm=!0,n.prop("disabled",!1)},clearUnloadConfirmation:function(){this.needsUnloadConfirm=!1,n.attr("disabled","disabled")},unloadConfirmation:function(e){if(e.data.view.needsUnloadConfirm)return e.returnValue=d.strings.unload_confirmation_msg,window.event.returnValue=d.strings.unload_confirmation_msg,d.strings.unload_confirmation_msg},updateModelOnChange:function(e){var n=e.data.view.model,i=a(e.target),t=i.closest("tr").data("id"),o=i.data("attribute"),s=i.val(),d=_.indexBy(n.get("rules"),"rule_id"),e={};i.is(":checkbox")&&(s=i.is(":checked")?s:""),d[t]&&d[t][o]===s||(e[t]={},e[t][o]=s),n.logChanges(e)}}))({model:new o({rules:d.rules}),el:e});s.render(),e.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,helper:function(e,n){return n.children().each(function(){a(this).width(a(this).width())}),n.css("left","0"),n},start:function(e,n){n.item.css("background-color","#f6f6f6")},stop:function(e,n){n.item.removeAttr("style"),n.item.trigger("updateMoveButtons")}})})}(jQuery,wc_gzd_admin_shipping_rules_params,wp,ajaxurl);
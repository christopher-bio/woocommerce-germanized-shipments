!function(l,o,p){l(function(){var e=l(".wc-gzd-shipments-shipping-rules-rows"),i=l(".wc-gzd-shipments-shipping-rules"),n=p.template("wc-gzd-shipments-shipping-rules-row"),t=p.template("wc-gzd-shipments-shipping-rules-packaging-info"),c={},a=Backbone.Model.extend({updateRules:function(e,i){0===Object.keys(e).length&&(e={});var n={...this.get("rules")};n[String(i)]=e,this.set("rules",n)},getRulesByPackaging:function(e){var i={...this.get("rules")};return i.hasOwnProperty(String(e))?i[String(e)]:{}}}),s=Backbone.View.extend({rowTemplate:n,packaging:"",initialize:function(){this.packaging=String(l(this.el).data("packaging")),l(this.el).on("change",{view:this},this.updateModelOnChange)},block:function(){l(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){l(this.el).unblock()},getRules:function(){return this.model.getRulesByPackaging(this.packaging)},render:function(){var e=this.getRules(),n=this;this.$el.empty(),this.unblock(),_.size(e)&&l.each(e,function(e,i){n.renderRow(i)})},renderRow:function(e){var i=this;i.$el.append(i.rowTemplate(e)),i.initRow(e)},initRow:function(i){var e=this.$el.find('tr[data-id="'+i.rule_id+'"]'),n=e.parents("tbody");e.find("select").each(function(){var e=l(this).data("attribute");l(this).find('option[value="'+i[e]+'"]').prop("selected",!0)}),e.find(".shipping-rules-type-container").hide(),e.find(".conditions-column:not(.conditions-when)").hide(),e.find(".shipping-rules-type").on("change",{view:this},this.onChangeRuleType),e.find(".shipping-rules-type").trigger("change"),e.find("input.decimal").on("change",{view:this},this.onChangeDecimal),e.find("input.wc_input_price").on("change",{view:this},this.onChangePrice),e.find("input.decimal, input.wc_input_price").trigger("change"),e.find(".shipping-rule-remove").on("click",{view:this},this.onDeleteRow),n.find("tr.wc-gzd-shipments-shipping-rules-packaging-info").length<=0&&(n.prepend(t),(e=n.find("tr.wc-gzd-shipments-shipping-rules-packaging-info")).find(".packaging-title").html(n.data("title")),n.data("help-tip")?e.find(".woocommerce-help-tip").attr("data-tip",n.data("help-tip")):e.find(".woocommerce-help-tip").remove()),l(document.body).trigger("wc-enhanced-select-init"),l(document.body).trigger("init_tooltips")},onChangeDecimal:function(e){l(this).closest("tr");var i=l(this);i.val(i.val().replace(".",o.decimal_separator))},onChangePrice:function(e){l(this).closest("tr");var i=l(this);i.val(i.val().replace(".",o.price_decimal_separator))},onChangeRuleType:function(e){var i=l(this).closest("tr"),n=l(this).val();i.find(".shipping-rules-type-container").hide(),i.find(".conditions-column:not(.conditions-when)").hide(),i.find(".shipping-rules-type-container-"+n).show(),i.find(".shipping-rules-type-container-"+n).parents(".conditions-column").show()},onDeleteRow:function(e){var i=e.data.view,n=i.model,t=i.getRules(),a="rule_"+l(this).closest("tr").data("id");e.preventDefault(),t[a]&&(delete t[a],n.updateRules(t,i.packaging)),i.render()},updateModelOnChange:function(e){var i=e.data.view,n=i.model,t=l(e.target),a="rule_"+t.closest("tr").data("id"),s=t.data("attribute"),r=t.val(),e=i.getRules();if(!t.is(":visible"))return!1;t.is(":checkbox")?r=t.is(":checked")?r:"":r&&t.hasClass("decimal")?r=parseFloat(r.replace(o.decimal_separator,".")):r&&t.hasClass("wc_input_price")&&(r=parseFloat(r.replace(o.price_decimal_separator,"."))),e[a]&&String(e[a][s])===String(r)||(e[a][s]=r,String(e[a].packaging)!==String(i.packaging)?(t=e[a].packaging,(r=(s=c[t]).getRules())[a]={...e[a]},delete e[a],n.updateRules(e,i.packaging),s.model.updateRules(r,t),i.render(),s.render()):n.updateRules(e,i.packaging))}}),r=new a({rules:o.rules});e.each(function(){var e=new s({model:r,el:l(this)});e.render(),c[l(this).data("packaging")]=e,l(this).sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,helper:function(e,i){return i.children().each(function(){l(this).width(l(this).width())}),i.css("left","0"),i},start:function(e,i){i.item.css("background-color","#f6f6f6")},stop:function(e,i){i.item.removeAttr("style"),i.item.trigger("updateMoveButtons")}})}),l(document).on("click",".wc-gzd-shipments-shipping-rule-add",function(){var e=l(".new-shipping-packaging").val(),i=c[e],n=i.model.getRulesByPackaging(e),t=_.extend({},o.default_shipping_rule,{rule_id:"new-"+_.size(n)+"-"+Date.now(),packaging:e,newRow:!0});return n["rule_"+t.rule_id]=t,i.model.updateRules(n,e),c[e].renderRow(t),!1}),l(document).on("change",".wc-gzd-shipments-shipping-rules-rows input.cb",function(){$selected=l(this).parents("table").find("input.cb:checked"),0<$selected.length?i.find(".wc-gzd-shipments-shipping-rule-remove").removeClass("disabled"):i.find(".wc-gzd-shipments-shipping-rule-remove").addClass("disabled")}),l(document).on("click",".wc-gzd-shipments-shipping-rule-remove",function(){var n=r.get("rules"),e=l(this),i=e.parents("table"),t=[];return i.find("input.cb:checked").each(function(){var e="rule_"+l(this).val(),i=l(this).parents("tr").find(".shipping-packaging").val();t.includes(i)||t.push(i),delete n[i][e]}),r.set("rules",n),t.forEach(function(e,i){c[e].render()}),e.addClass("disabled"),!1})})}(jQuery,wc_gzd_admin_shipping_rules_params,wp,ajaxurl);
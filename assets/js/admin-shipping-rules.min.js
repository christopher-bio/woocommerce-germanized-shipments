!function(l,p,d){l(function(){var e=l(".wc-gzd-shipments-shipping-rules-rows"),s=l(".wc-gzd-shipments-shipping-rules"),i=d.template("wc-gzd-shipments-shipping-rules-row"),n=d.template("wc-gzd-shipments-shipping-rules-packaging-info"),c={},t=Backbone.Model.extend({updateRules:function(e,i){0===Object.keys(e).length&&(e={});var t={...this.get("rules")};t[String(i)]=e,this.set("rules",t)},getRulesByPackaging:function(e){var i={...this.get("rules")};return i.hasOwnProperty(String(e))?i[String(e)]:{}}}),r=Backbone.View.extend({rowTemplate:i,packaging:"",initialize:function(){this.packaging=String(l(this.el).data("packaging")),l(this.el).on("change",{view:this},this.updateModelOnChange)},block:function(){l(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){l(this.el).unblock()},getRules:function(){return this.model.getRulesByPackaging(this.packaging)},render:function(){var e=this.getRules(),t=this;this.$el.empty(),this.unblock(),_.size(e)&&l.each(e,function(e,i){t.renderRow(i)})},renderRow:function(e){var i=this;i.$el.append(i.rowTemplate(e)),i.initRow(e)},initRow:function(i){var e=this.$el.find('tr[data-id="'+i.rule_id+'"]'),t=e.parents("tbody");e.find("select").each(function(){var e=l(this).data("attribute");l(this).find('option[value="'+i[e]+'"]').prop("selected",!0)}),e.find(".shipping-rules-type-container").hide(),e.find(".conditions-column:not(.conditions-when)").hide(),e.find(".shipping-rules-type").on("change",{view:this},this.onChangeRuleType),e.find(".shipping-rules-type").trigger("change"),e.find("input.decimal").on("change",{view:this},this.onChangeDecimal),e.find("input.wc_input_price").on("change",{view:this},this.onChangePrice),e.find("input.decimal, input.wc_input_price").trigger("change"),e.find(".shipping-rule-remove").on("click",{view:this},this.onDeleteRow),e.find(".shipping-rule-add").on("click",{view:this},this.onAddRow),t.find("tr.wc-gzd-shipments-shipping-rules-packaging-info").length<=0&&(t.prepend(n),(e=t.find("tr.wc-gzd-shipments-shipping-rules-packaging-info")).find(".packaging-title").html(t.data("title")),t.data("help-tip")?e.find(".woocommerce-help-tip").attr("data-tip",t.data("help-tip")):e.find(".woocommerce-help-tip").remove()),l(document.body).trigger("wc-enhanced-select-init"),l(document.body).trigger("init_tooltips")},onChangeDecimal:function(e){l(this).closest("tr");var i=l(this);i.val(i.val().replace(".",p.decimal_separator))},onChangePrice:function(e){l(this).closest("tr");var i=l(this);i.val(i.val().replace(".",p.price_decimal_separator))},onChangeRuleType:function(e){var i=l(this).closest("tr"),t=l(this).val();i.find(".shipping-rules-type-container").hide(),i.find(".conditions-column:not(.conditions-when)").hide(),i.find(".shipping-rules-type-container-"+t).show(),i.find(".shipping-rules-type-container-"+t).parents(".conditions-column").show()},onDeleteRow:function(e){var i=e.data.view,t=i.model,n=i.getRules(),e="rule_"+l(this).closest("tr").data("id");return n[e]&&(delete n[e],t.updateRules(n,i.packaging)),i.render(),0<i.$el.find("tr:last").length&&i.$el.find("tr:last").addClass("current"),!1},onAddRow:function(e){var i=e.data.view,t=i.model,n=i.getRules(),e=n["rule_"+l(this).closest("tr").data("id")],e=_.extend({},e,{rule_id:"new-"+_.size(n)+"-"+Date.now(),newRow:!0,costs:""});return-1!==l.inArray(e.type,["weight","total"])&&(e[e.type+"_from"]=e[e.type+"_to"],e[e.type+"_to"]=""),n["rule_"+e.rule_id]=e,t.updateRules(n,i.packaging),i.renderRow(e),i.$el.find('tr[data-id="'+e.rule_id+'"]').trigger("focus"),!1},updateModelOnChange:function(e){var i=e.data.view,t=i.model,n=l(e.target),s="rule_"+n.closest("tr").data("id"),r=n.data("attribute"),a=n.val(),e=i.getRules();if(!n.is(":visible"))return!1;n.is(":checkbox")?a=n.is(":checked")?a:"":a&&n.hasClass("decimal")?a=parseFloat(a.replace(p.decimal_separator,".")):a&&n.hasClass("wc_input_price")&&(a=parseFloat(a.replace(p.price_decimal_separator,"."))),e[s]&&String(e[s][r])===String(a)||(e[s][r]=a,String(e[s].packaging)!==String(i.packaging)?(n=e[s].packaging,(a=(r=c[n]).getRules())[s]={...e[s]},delete e[s],t.updateRules(e,i.packaging),r.model.updateRules(a,n),i.render(),r.render()):t.updateRules(e,i.packaging))}}),a=new t({rules:p.rules});e.each(function(){var e=new r({model:a,el:l(this)});e.render(),c[l(this).data("packaging")]=e,l(this).sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,helper:function(e,i){return i.children().each(function(){l(this).width(l(this).width())}),i.css("left","0"),i},start:function(e,i){i.item.css("background-color","#f6f6f6")},stop:function(e,i){i.item.removeAttr("style"),i.item.trigger("updateMoveButtons"),i.item.trigger("focus")}})}),l(document).on("change",".wc-gzd-shipments-shipping-rules-cb-all",function(){var e=l(this).parents("table");l(this).is(":checked")?e.find("input.cb").prop("checked",!0):e.find("input.cb").prop("checked",!1)}),l(document).on("click",".wc-gzd-shipments-shipping-rule-add",function(){var e=l(".new-shipping-packaging").val(),i=c[e],t=i.model.getRulesByPackaging(e),n=_.extend({},p.default_shipping_rule,{rule_id:"new-"+_.size(t)+"-"+Date.now(),packaging:e,newRow:!0});return t["rule_"+n.rule_id]=n,i.model.updateRules(t,e),c[e].renderRow(n),c[e].$el.find('tr[data-id="'+n.rule_id+'"]').trigger("focus"),!1}),l(document).on("click",".wc-gzd-shipments-shipping-rule-remove",function(){var t=a.get("rules"),e=l(this),i=e.parents("table"),n=[];return i.find("input.cb:checked").each(function(){var e="rule_"+l(this).val(),i=l(this).parents("tr").find(".shipping-packaging").val();n.includes(i)||n.push(i),delete t[i][e]}),a.set("rules",t),n.forEach(function(e,i){c[e].render()}),e.addClass("disabled"),i.find(".wc-gzd-shipments-shipping-rules-cb-all").prop("checked",!1),!1}),l(document).on("keydown",function(e){var i=s.find("tr.current"),t=l(".wc-gzd-shipments-shipping-rules.has-focus");if(0!==i.length||0!==t.length){var n=e.metaKey||e.ctrlKey;return!n||"d"!==e.key&&"-"!==e.key?i&&n&&"+"===e.key?(i.find(".shipping-rule-add").trigger("click"),e.preventDefault(),e.stopPropagation(),!1):t&&n&&"a"===e.key?(t.find(".wc-gzd-shipments-shipping-rules-cb-all").prop("checked",!t.find(".wc-gzd-shipments-shipping-rules-cb-all").is(":checked")),t.find(".wc-gzd-shipments-shipping-rules-cb-all").trigger("change"),e.preventDefault(),e.stopPropagation(),!1):void 0:($selected=s.find("input.cb:checked"),0<$selected.length?s.find(".wc-gzd-shipments-shipping-rule-remove").trigger("click"):i&&i.find(".shipping-rule-remove").trigger("click"),e.preventDefault(),e.stopPropagation(),!1)}}),l(document).on("change",".wc-gzd-shipments-shipping-rules-rows input.cb, .wc-gzd-shipments-shipping-rules-cb-all",function(){$selected=l(this).parents("table").find("input.cb:checked"),0<$selected.length?s.find(".wc-gzd-shipments-shipping-rule-remove").removeClass("disabled"):s.find(".wc-gzd-shipments-shipping-rule-remove").addClass("disabled")}),l(document).on("mouseup",function(e){var i=l("table.wc-gzd-shipments-shipping-rules");i.is(e.target)||0!==i.has(e.target).length?i.addClass("has-focus"):(i.removeClass("has-focus"),i.find("tr").removeClass("current"))}),l(document).on("click",".wc-gzd-shipments-shipping-rules tbody, .wc-gzd-shipments-shipping-rules input",function(){l(this).trigger("focus")}),l(document).on("focus click",".wc-gzd-shipments-shipping-rules input, .wc-gzd-shipments-shipping-rules tr",function(e){l(this).parents("table").find("tr").removeClass("current"),l(this).closest("tr:not(.wc-gzd-shipments-shipping-rules-packaging-info)").addClass("current")})})}(jQuery,wc_gzd_admin_shipping_rules_params,wp,ajaxurl);